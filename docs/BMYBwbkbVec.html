<html><head><title>Faiss - Vector Compression with PQ and IVFPQ (in Python)</title>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        color: #333;
    }
    .container {
        width: 80%;
        margin: auto;
        overflow: hidden;
    }
    h2, h3 {
        color: #333;
        text-align: center;
    }
    a {
        color: #0000FF;  /* Traditional blue color for links */
        text-decoration: none;
    }
    a:hover {
        text-decoration: underline;
    }
    img {
        display: block;
        margin: auto;
        max-width: 100%;
    }
    .c {
        margin: 10px 0;
    }
    .s, .t {
        display: inline-block;
        margin-right: 5px;
    }
    .max-width {
        max-width: 800px;
        margin: auto;
        padding-left: 20px;
    }
    table {
        width: 100%;
        border-collapse: collapse;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 8px;
    }
    tr:nth-child(even) {
        background-color: #f2f2f2;
    }
    tr:nth-child(odd) {
        background-color: #e6e6e6;
    }
</style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-69VLBMTTP0"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-69VLBMTTP0');
    </script>
    </head><body><div class='container'><a href="index.html">back to index</a><h2>Faiss - Vector Compression with PQ and IVFPQ (in Python)</h2><a href="https://www.youtube.com/watch?v=BMYBwbkbVec"><img src="https://i.ytimg.com/vi_webp/BMYBwbkbVec/maxresdefault.webp" style="width:50%;"></a><div><br></div><h3>Chapters</h3><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=0">0:0</a> Intro<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=24">0:24</a> Demonstration<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=75">1:15</a> Dataset<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=125">2:5</a> Initialization<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=255">4:15</a> Adding vectors<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=580">9:40</a> Memory Usage<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=705">11:45</a> Composite Index<br><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=870">14:30</a> Results<br><br><div style="text-align: left;"><a href="./BMYBwbkbVec.html">Whisper Transcript</a> | <a href="./transcript_BMYBwbkbVec.html">Transcript Only Page</a></div><br><div style="max-width: 800px;"><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=0" target="_blank">00:00:00.000</a></span> | <span class="t">Hi, welcome to this video. We're going to have a look at how we can implement a product quantization</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=6" target="_blank">00:00:06.800</a></span> | <span class="t">index or index PQ in FICE, and we're also going to have a look at how we can implement a composite</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=13" target="_blank">00:00:13.920</a></span> | <span class="t">index using an inverted file list, IVF, and also PQ together to improve our results or our</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=23" target="_blank">00:00:23.200</a></span> | <span class="t">performance even further. Now, we'll just have a quick look at this. If you watched the previous</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=28" target="_blank">00:00:28.240</a></span> | <span class="t">video on the logic behind PQ, you'll recognize this, but this is just demonstrating the speed</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=33" target="_blank">00:00:33.440</a></span> | <span class="t">increase that we can get and also mainly the memory increase, which is the important factor in</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=39" target="_blank">00:00:39.680</a></span> | <span class="t">PQ. And obviously, there's a huge increase here. So the speed increases is a five to six times</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=46" target="_blank">00:00:46.960</a></span> | <span class="t">increase with just PQ, and the memory decrease is huge. It's like a 97% reduction in memory.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=55" target="_blank">00:00:55.040</a></span> | <span class="t">Now, I'm not going to go through how all of that works because we already did it in the last video.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=61" target="_blank">00:01:01.200</a></span> | <span class="t">So there is a link to that video in the description. So if you'd like to go through that,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=67" target="_blank">00:01:07.200</a></span> | <span class="t">go ahead and go through it. But if you just want to see how this works in FICE,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=71" target="_blank">00:01:11.200</a></span> | <span class="t">then continue and we'll jump straight into it. Okay, so the first thing that we need to do is</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=79" target="_blank">00:01:19.520</a></span> | <span class="t">actually get our data. So we're going to be using the SIFT1M dataset. Again, in the description,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=85" target="_blank">00:01:25.840</a></span> | <span class="t">there's a link to a notebook where you can download and also load that into your own notebook</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=92" target="_blank">00:01:32.080</a></span> | <span class="t">if you'd like to do that. But I should say it's a pretty straightforward, very popular</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=98" target="_blank">00:01:38.320</a></span> | <span class="t">dataset for these sort of examples I use all the time. And I'll just show you the sort of shape.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=105" target="_blank">00:01:45.040</a></span> | <span class="t">So XB, it is the vectors that we'll be indexing. So we're going to index these vectors in our index</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=113" target="_blank">00:01:53.760</a></span> | <span class="t">in FICE and search through them. Typically, it has 1 million vectors. I'm going to stick with</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=120" target="_blank">00:02:00.240</a></span> | <span class="t">500K because it can just take a little bit of time for everything to load.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=123" target="_blank">00:02:03.680</a></span> | <span class="t">Although that being said, I don't think it's that bad. So let me, yeah, you know what? Let's just</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=131" target="_blank">00:02:11.200</a></span> | <span class="t">go with 1 million. It's more interesting. And then XQ, I'm just using a single vector here.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=139" target="_blank">00:02:19.760</a></span> | <span class="t">So we just have one vector in there. As you see, dimensionality for all of our vectors here is 128,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=145" target="_blank">00:02:25.280</a></span> | <span class="t">which is pretty typical, but it's definitely on the lower end for dense vectors. So let's first</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=152" target="_blank">00:02:32.320</a></span> | <span class="t">initialize our PQ index. So we need to import FICE and we'll get our dimensionality, which is</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=159" target="_blank">00:02:39.760</a></span> | <span class="t">XB.shape1. Now I'm using this slightly different syntax to usual to align better with the PQ</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=170" target="_blank">00:02:50.320</a></span> | <span class="t">notation. Usually, you can go with lowcase D and you can go with that. It's fine. It's not really</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=175" target="_blank">00:02:55.200</a></span> | <span class="t">an issue. I'm just going to go with uppercase for now to align better to that notation if you are</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=181" target="_blank">00:03:01.520</a></span> | <span class="t">following on from the previous video. And we're going to set M equals to 8, so that's how many</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=186" target="_blank">00:03:06.320</a></span> | <span class="t">subvectors we have. Now, typically, we assert that D is divisible by M, but we already know it is,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=193" target="_blank">00:03:13.200</a></span> | <span class="t">so I'm going to skip that. But that's something that you do need to make sure that D is divisible.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=200" target="_blank">00:03:20.240</a></span> | <span class="t">In fact, you know what? I'm going to put it in anyway. So let's assert that D is divisible by M.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=207" target="_blank">00:03:27.040</a></span> | <span class="t">Okay, just put this in because otherwise we are not splitting our vectors or subvectors equally,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=213" target="_blank">00:03:33.520</a></span> | <span class="t">and we will not be allowed to do that. So we do need to make sure that's always the case.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=217" target="_blank">00:03:37.840</a></span> | <span class="t">And then we're going to set the nBits value. So this is the number of bits per subquantizer. So</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=225" target="_blank">00:03:45.840</a></span> | <span class="t">if you were watching previous videos, we would see this as, so the K star value is equal to 2</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=236" target="_blank">00:03:56.240</a></span> | <span class="t">to the power of nBits. Okay, so the number of centroids that we have within each subquantizer.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=243" target="_blank">00:04:03.920</a></span> | <span class="t">And then we initialize our index. So index equals FICE, index PQ, D, M, and nBits.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=253" target="_blank">00:04:13.040</a></span> | <span class="t">Okay, that's our index ready to go. And what we need to do now is actually add our vectors. Now,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=263" target="_blank">00:04:23.520</a></span> | <span class="t">you have to think with product quantization, we are clustering. Our subquantizers are using</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=270" target="_blank">00:04:30.480</a></span> | <span class="t">clustering. So we do actually need to train it. So we can see if an index needs to be trained or not</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=277" target="_blank">00:04:37.840</a></span> | <span class="t">by using this. So we write index is trained. In this case, is trained is false. So that means we</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=282" target="_blank">00:04:42.880</a></span> | <span class="t">need to train it before we add our vectors. So to do that, we need to write index train,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=291" target="_blank">00:04:51.120</a></span> | <span class="t">and then we pass it xB. We run that. And this can take a little bit of time. It shouldn't be too</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=296" target="_blank">00:04:56.080</a></span> | <span class="t">long. But if you start increasing the nBits value, which is probably a good idea. I mean, nBits of</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=306" target="_blank">00:05:06.160</a></span> | <span class="t">maybe 11 is actually what is recommended in the PQ paper. But I'm not using it here because it</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=314" target="_blank">00:05:14.480</a></span> | <span class="t">takes a long time to train and build your vectors. So I'm avoiding it here. But if you're using this,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=324" target="_blank">00:05:24.400</a></span> | <span class="t">I definitely recommend trying those larger nBits values. It's also worth noting that</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=332" target="_blank">00:05:32.640</a></span> | <span class="t">when we're using composite index of IVF and PQ, we can't use an nBits value of greater than</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=340" target="_blank">00:05:40.080</a></span> | <span class="t">8. But we'll move on to that anyway. That has to be something that they've hard-coded into FICE.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=347" target="_blank">00:05:47.280</a></span> | <span class="t">For now, I think they should be removing that limitation at some point. So we have now trained,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=354" target="_blank">00:05:54.320</a></span> | <span class="t">and now we can add our vectors. So now what we want to do is we'll return, say, the top</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=363" target="_blank">00:06:03.280</a></span> | <span class="t">k most similar vectors. We'll go with k of 100. And then we want to do our search.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=370" target="_blank">00:06:10.320</a></span> | <span class="t">So we're going to go distance. So typically, we'd write d here. But obviously, we're already using</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=377" target="_blank">00:06:17.040</a></span> | <span class="t">d. So I'm going to write distance equals index.search. And then in here, we get past our</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=384" target="_blank">00:06:24.400</a></span> | <span class="t">query. And we also pass k. And that will return the k nearest neighbors in that search. So in here,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=395" target="_blank">00:06:35.120</a></span> | <span class="t">if we write shape, we see that we have 100 of those. And then distances here are the actual</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=401" target="_blank">00:06:41.120</a></span> | <span class="t">distances. So i are the indices of the nearest neighbors. Distance is the actual distances that</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=407" target="_blank">00:06:47.840</a></span> | <span class="t">they have returned. Now let's go ahead. And what I'm going to do is I'm going to time it. So we</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=414" target="_blank">00:06:54.240</a></span> | <span class="t">can use this time function to essentially run this cell multiple times and get the average time</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=422" target="_blank">00:07:02.240</a></span> | <span class="t">taken to run it, which is quite useful when we're comparing different indexes.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=427" target="_blank">00:07:07.440</a></span> | <span class="t">And we'll do index.search. And we want x, q, and k. Now we see that that took 3.34 milliseconds.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=441" target="_blank">00:07:21.440</a></span> | <span class="t">So reasonably fast. Let's compare that to a flat index. So we'll do L2 index equals FICE</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=449" target="_blank">00:07:29.760</a></span> | <span class="t">index flat L2, d with a capital, L2 index dot add. And we want to add all of our data. So it's b.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=464" target="_blank">00:07:44.880</a></span> | <span class="t">And let's time that again. So I'm just going to copy this.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=470" target="_blank">00:07:50.560</a></span> | <span class="t">Here. And we'll just replace that with L2 index. And let's see what we get. OK. So an average of</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=478" target="_blank">00:07:58.320</a></span> | <span class="t">19.5 milliseconds. So already, this is pretty quick, right? Which is cool. Now we can check</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=486" target="_blank">00:08:06.720</a></span> | <span class="t">the performance of our index as well. Now this varies from all the times I've tested it. But we</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=493" target="_blank">00:08:13.840</a></span> | <span class="t">should get something around maybe 50. So 50% recall isn't exactly cutting edge. But that's PQ.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=502" target="_blank">00:08:22.480</a></span> | <span class="t">That is how it is. If we want high recall, we can increase n bits to get that. But it's definitely</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=509" target="_blank">00:08:29.920</a></span> | <span class="t">a drawback of using PQ. OK. So we want to sum one value for every value that we find in our index.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=521" target="_blank">00:08:41.920</a></span> | <span class="t">So in the return indexes for our PQ results, if they are in the L2 results. So we're just saying,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=531" target="_blank">00:08:51.840</a></span> | <span class="t">you know, how many of the results returned by our PQ index were also returned by our L2 index,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=537" target="_blank">00:08:57.680</a></span> | <span class="t">which we are seeing as the 100% recall. So L2 index, 100% recall. And here we're seeing, OK,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=546" target="_blank">00:09:06.080</a></span> | <span class="t">how many of those do we match to using our PQ index. If i in L2 i. So I actually need to just</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=556" target="_blank">00:09:16.240</a></span> | <span class="t">copy this, pull it down here. So when we use a time it, we can't get any variables out from it,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=564" target="_blank">00:09:24.160</a></span> | <span class="t">which is, I don't know why, but it's a little bit annoying. So we will get L2 this and L2 i.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=574" target="_blank">00:09:34.560</a></span> | <span class="t">OK. So this time we get 38% recall. OK. So let's now have a look at the memory usage</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=587" target="_blank">00:09:47.520</a></span> | <span class="t">of each of these. So I'm just going to define a function, get to memory,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=591" target="_blank">00:09:51.120</a></span> | <span class="t">so we can more easily compare those. And what we'll do is we'll just write our index to file,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=600" target="_blank">00:10:00.080</a></span> | <span class="t">like so, index. And I'll just call it temp index now, because we're going to delete it straight</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=606" target="_blank">00:10:06.640</a></span> | <span class="t">away afterwards. We're just writing it to file so we can read, see how large the index is.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=612" target="_blank">00:10:12.480</a></span> | <span class="t">And then we delete it again. The file size equals OS path dot get size to get size of that index in</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=623" target="_blank">00:10:23.120</a></span> | <span class="t">bytes, I think. So we'll do temp dot index. And then we don't really-- we're just using that to</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=631" target="_blank">00:10:31.680</a></span> | <span class="t">check the size, so we just want to delete that afterwards. So like so. And then we just return</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=640" target="_blank">00:10:40.720</a></span> | <span class="t">the file size. OK. So let's do that for both of our indexes. So we get the memory for the L2 index</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=652" target="_blank">00:10:52.880</a></span> | <span class="t">first. Let me-- so that's remove, not remote. OK. So we get pretty big. That's half a gigabyte,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=668" target="_blank">00:11:08.800</a></span> | <span class="t">which is massive. And then we want to get memory again for our index. Let's see what we have.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=678" target="_blank">00:11:18.960</a></span> | <span class="t">So now we have eight megabytes. So that's a massive draw. That's eight over 512.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=692" target="_blank">00:11:32.800</a></span> | <span class="t">So it's a 98.4% reduction in size, which is huge, which is really cool.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=707" target="_blank">00:11:47.680</a></span> | <span class="t">Now, we-- like I said before, we have this composite index where we have both the IVF step</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=712" target="_blank">00:11:52.480</a></span> | <span class="t">and a PQ step. So we're going to have a look at how we can implement that, and we'll see</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=716" target="_blank">00:11:56.880</a></span> | <span class="t">that memory decrease will be slightly less significant because it's a more complex index,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=723" target="_blank">00:12:03.200</a></span> | <span class="t">although very small still. And then the speed decrease will be absolutely insane. So we'll go</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=730" target="_blank">00:12:10.720</a></span> | <span class="t">into that. So now we have nlist, which is the number of cells within our IVF index.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=742" target="_blank">00:12:22.320</a></span> | <span class="t">So if we just have a quick look at what that might look like. So imagine these are our PQ vectors</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=748" target="_blank">00:12:28.320</a></span> | <span class="t">on a 2D space. Adding IVF essentially does this. So we add all these separating cells called</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=756" target="_blank">00:12:36.640</a></span> | <span class="t">Voronoi cells, and each of the vectors within each cell is assigned to the vector to that cell</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=763" target="_blank">00:12:43.440</a></span> | <span class="t">centroid. Now, here, you see the magenta dot at the bottom, that's our query vector, and it's</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=771" target="_blank">00:12:51.280</a></span> | <span class="t">landed within that cell that you see highlighted. Now, because it's landed in there, we only compare</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=778" target="_blank">00:12:58.800</a></span> | <span class="t">it to those vectors within that cell that are also assigned to the same cell. And that's what we're</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=785" target="_blank">00:13:05.520</a></span> | <span class="t">doing with nlist. We're saying how many of those cells we would like to have. Now, we're going to</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=790" target="_blank">00:13:10.960</a></span> | <span class="t">go with 2,048, and it's worth noting that this must be greater than or equal to kthon, which is</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=802" target="_blank">00:13:22.720</a></span> | <span class="t">equal to 2 to the power of n bits. So in this case, we could go with 256 to be fair. Let's</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=813" target="_blank">00:13:33.680</a></span> | <span class="t">go with that for now and we'll see how it goes. And then we initialize our index like this. So we</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=818" target="_blank">00:13:38.720</a></span> | <span class="t">go index equals FICE index IVFPQ. And in here, we need to pass our vectors. So in this case,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=830" target="_blank">00:13:50.320</a></span> | <span class="t">we will just-- when I say vectors, I mean the index that contains our vectors. So you typically</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=838" target="_blank">00:13:58.720</a></span> | <span class="t">see this written as quantizer, but I'm going to write it as vectors because I think it's a little</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=842" target="_blank">00:14:02.480</a></span> | <span class="t">bit less confusing. So we'll do FICE index flat L2. So we're just going to use these as our starting</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=849" target="_blank">00:14:09.520</a></span> | <span class="t">point. But that doesn't mean we're storing these as they are in our index. They actually get</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=855" target="_blank">00:14:15.120</a></span> | <span class="t">processed using the PQ step as we already did before. So we have Vects, D, nlist, M, and nbits.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=870" target="_blank">00:14:30.320</a></span> | <span class="t">OK, so we now have our index and we can see if it's trained like we did before. Obviously,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=876" target="_blank">00:14:36.160</a></span> | <span class="t">it will not be because we are still using PQ again. So we need to train that and we do the</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=882" target="_blank">00:14:42.880</a></span> | <span class="t">same as we did before. So train xp. After that, we add our vectors and we can get our results.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=893" target="_blank">00:14:53.680</a></span> | <span class="t">So index.search xqk. OK, now we haven't seen how fast that is, so let's have a look. We'll</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=905" target="_blank">00:15:05.440</a></span> | <span class="t">just time it again. OK, and although the actual search took longer, it's because we're looping</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=914" target="_blank">00:15:14.000</a></span> | <span class="t">through. So we had 10,000 loops for this test and we got this number, which is insanely small.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=921" target="_blank">00:15:21.600</a></span> | <span class="t">So 0.001. No, that's not right. What are we on? This. 0.1 milliseconds. Sorry.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=935" target="_blank">00:15:35.200</a></span> | <span class="t">So 0.1 milliseconds. What did we get before? It was here. So this is using our flat index,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=945" target="_blank">00:15:45.600</a></span> | <span class="t">20 milliseconds. If we go up a little further, we see 3.3 milliseconds for that search up there.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=951" target="_blank">00:15:51.600</a></span> | <span class="t">So yeah, super fast. And then if we check the recall, so we'll use the same as what we used</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=960" target="_blank">00:16:00.400</a></span> | <span class="t">before. So where is our sun here? Like I said, this can go up and down. So at 24 this time,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=968" target="_blank">00:16:08.160</a></span> | <span class="t">it's pretty, pretty bad. But I mean, like I said, PQ isn't the best for recall. But what we can do</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=975" target="_blank">00:16:15.920</a></span> | <span class="t">is actually, because we're using IVF, we can increase the number of cells that we search</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=982" target="_blank">00:16:22.000</a></span> | <span class="t">through. So you can kind of see that happening here. So using the example from before, we solve</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=987" target="_blank">00:16:27.520</a></span> | <span class="t">an n-probe value of 1, which is the default. Increase it to 2, 3, 4, 5, and so on and so on.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=993" target="_blank">00:16:33.600</a></span> | <span class="t">And we can increase that all the way up to search all of our n-probe values. Of course,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=997" target="_blank">00:16:37.920</a></span> | <span class="t">that is kind of a waste of time, because if you're searching through all of your cells,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1002" target="_blank">00:16:42.640</a></span> | <span class="t">you're basically just doing a flat search with the additional overhead of having an IVF index. So</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1007" target="_blank">00:16:47.680</a></span> | <span class="t">it's even slower. We can use that information. So we know that if we set our index.n-probe</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1016" target="_blank">00:16:56.400</a></span> | <span class="t">equal to 2048, which is the number of cells that we-- the maximum number of cells that we set.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1022" target="_blank">00:17:02.720</a></span> | <span class="t">Or did we use 2, 5, 6? No, we used 2, 5, 6, so the endless value.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1027" target="_blank">00:17:07.360</a></span> | <span class="t">So we can just put endless here. If we do that and we do a search again,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1032" target="_blank">00:17:12.640</a></span> | <span class="t">xq and k, and we go dist i. Do that again. And let's come up here, get our recall. So we see</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1046" target="_blank">00:17:26.080</a></span> | <span class="t">that the maximum recall we're going to get with this instance is 32%. Now, this is pretty low,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1052" target="_blank">00:17:32.640</a></span> | <span class="t">so working on it before, I was getting 50%, 52%. It's also a case of there is some randomness in</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1062" target="_blank">00:17:42.000</a></span> | <span class="t">what you're going to output from your index. But of course, again, we can also increase n bits</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1067" target="_blank">00:17:47.600</a></span> | <span class="t">or do some other things. So we can increase n bits, try decreasing m, and see how things work.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1076" target="_blank">00:17:56.720</a></span> | <span class="t">But it's also worth noting with IVFPQ, the n bits value does have to be 8, at the moment at least.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1083" target="_blank">00:18:03.600</a></span> | <span class="t">It's just that it's something that's hardcoded into FICE. Unless you want to go into the FICE</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1089" target="_blank">00:18:09.200</a></span> | <span class="t">code and then change that, you can remove it if you want. Now, what we want to do is obviously</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1093" target="_blank">00:18:13.600</a></span> | <span class="t">not search through the entire index. So we're going to change n-probe. Let me also bring this</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1100" target="_blank">00:18:20.960</a></span> | <span class="t">down. We're going to change n-probe to something that is not quite as high, so maybe 20.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1110" target="_blank">00:18:30.160</a></span> | <span class="t">We'll get 33, so that's high enough for us to get our maximum performance. But obviously,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1116" target="_blank">00:18:36.880</a></span> | <span class="t">it's going to be a lot quicker because we're searching through 20 cells rather than 256.</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1121" target="_blank">00:18:41.120</a></span> | <span class="t">Let's try 10, 32, so increase it a little bit to 12, still 32, 16, 33. So around this area here,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1135" target="_blank">00:18:55.360</a></span> | <span class="t">so 14, 13. So 13 is our optimum n-probe value where we get the max recall out of that,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1145" target="_blank">00:19:05.040</a></span> | <span class="t">the quickest time. But of course, which parameters you use is completely up to you,</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1151" target="_blank">00:19:11.120</a></span> | <span class="t">and it depends on your use case as well. So that's it for this video. Thank you very much</span></div><div class="c"><span class="s"><a href="https://www.youtube.com/watch?v=BMYBwbkbVec&t=1156" target="_blank">00:19:16.080</a></span> | <span class="t">for watching. I hope it's been useful, and I will see you in the next one. Bye!</span></div></div></body></html>